<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>Balsavimų panašumas</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      font-size: 1.05rem;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.3rem;
    }

    .subtitle {
      font-size: 1rem;
      color: #555;
      margin-bottom: 1rem;
    }

    label {
      font-weight: 600;
    }

    select {
      min-width: 350px;
      padding: 6px 10px;
      font-size: 1rem;
      margin: 6px 0 10px 0;
    }

    .status {
      margin-top: 6px;
      margin-bottom: 8px;
      font-size: 1rem;
      color: #555;
    }

    .error {
      color: #b00020;
      font-weight: 600;
      margin-top: 10px;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-bottom: 6px;
    }

    .filters-row > div {
      display: flex;
      flex-direction: column;
    }

    .table-wrapper {
      max-width: 100%;
      overflow-x: auto;      /* horizontalus scroll mažiems ekranams */
    }

    .table-container {
      max-height: 75vh;
      overflow-y: auto;      /* vertikalus scroll su sticky header */
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 650px;
    }

    th, td {
      border-bottom: 1px solid #e0e0e0;
      padding: 4px 8px;
      font-size: 1.05rem;
      line-height: 1.25;
    }

    th {
      background: #f6f6f6;
      text-align: left;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tr:nth-child(even) td {
      background: #fafafa;
    }

    .number-cell {
      text-align: right;
      white-space: nowrap;
      width: 60px;
    }

    .name-cell {
      white-space: nowrap;
      width: 260px;
    }

    .party-cell {
      white-space: nowrap;
      width: 240px;
    }

    .party-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
    }

    .sortable {
      cursor: pointer;
      user-select: none;
    }

    .sortable::after {
      content: " ⇅";
      font-size: 0.8rem;
      color: #999;
    }

    .sortable.sorted-asc::after {
      content: " ↑";
      color: #555;
    }

    .sortable.sorted-desc::after {
      content: " ↓";
      color: #555;
    }

    @media (max-width: 768px) {
      body {
        margin: 10px;
        font-size: 1rem;
      }
      h1 {
        font-size: 1.4rem;
      }
      .subtitle {
        font-size: 0.95rem;
      }
      select {
        min-width: 260px;
      }
      table {
        min-width: 600px;
      }
    }
  </style>
</head>
<body>
  <h1>Balsavimų panašumas</h1>
  <div class="subtitle">
    Pasirink Seimo narį ir pamatyk, su kuo dažniausiai balsavo vienodai (pagal bendrų balsavimų skaičių).
  </div>

  <div class="filters-row">
    <div>
      <label for="memberSelect">Pasirink vardą ir pavardę:</label>
      <select id="memberSelect" disabled>
        <option>Įkeliami duomenys...</option>
      </select>
    </div>

    <div>
      <label for="partyFilter">Filtruoti pagal partiją / frakciją:</label>
      <select id="partyFilter" disabled>
        <option value="ALL">Visos partijos</option>
      </select>
    </div>
  </div>

  <div id="status" class="status">Bandome įkelti duomenis iš „common_votes.csv“...</div>
  <div id="error" class="error" style="display:none;"></div>

  <div class="table-wrapper">
    <div class="table-container">
      <table id="resultTable">
        <thead>
          <tr>
            <th>#</th>
            <th class="sortable" data-sort-key="name">Vardas, pavardė</th>
            <th class="sortable" data-sort-key="party">Partija / frakcija</th>
            <th class="sortable" data-sort-key="votes">Bendri balsavimai</th>
          </tr>
        </thead>
        <tbody id="resultBody">
          <!-- Rezultatai bus pildomi čia -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Globalūs kintamieji
    const adjacency = {};   // { member: { otherMember: commonVotes, ... }, ... }
    const memberParty = {}; // { member: partyName }

    const memberSelect = document.getElementById("memberSelect");
    const partyFilterSelect = document.getElementById("partyFilter");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const resultBody = document.getElementById("resultBody");

    // Dabartiniai rodymo duomenys ir rikiavimo / filtro būsena
    let currentRows = []; // { name, partyName, votes }
    let currentSort = { key: "votes", direction: "desc" };
    let currentPartyFilter = "ALL";

    // Partijų spalvos pagal trumpinius
    const partyColors = {
      "LSDP":  "#e53935", // ryški raudona
      "TS-LKD":"#1e3a8a", // tamsi mėlyna
      "DSVL":  "#0d47a1", // tamsi "navy" mėlyna
      "LS":    "#fb8c00", // oranžinė
      "LVŽS":  "#2e7d32", // žalia
      "NS":    "#b71c1c", // raudona
      "NA":    "#ff9800", // oranžinė / ruda
      "PPNA":  "#ff9800"  // tas pats kaip Nemuno aušra
    };

    function getPartyColor(party) {
      if (!party) return "#9e9e9e"; // jei nėra – pilka
      const upper = party.toUpperCase();
      for (const [abbr, color] of Object.entries(partyColors)) {
        if (upper.includes(abbr)) {
          return color;
        }
      }
      // bandymas pagal raktažodžius, jei nenaudotas trumpinys
      if (upper.includes("SOCIALDEMOKRAT")) return partyColors["LSDP"];
      if (upper.includes("KRIKŠČIONYS DEMOKRATAI")) return partyColors["TS-LKD"];
      if (upper.includes("LIBERALŲ SĄJŪDIS")) return partyColors["LS"];
      if (upper.includes("VALSTIEČIŲ") || upper.includes("ŽALIŲJŲ")) return partyColors["LVŽS"];
      if (upper.includes("NEMUNO AUŠRA")) return partyColors["NA"];
      if (upper.includes("VARDAN LIETUVOS")) return partyColors["DSVL"];
      if (upper.includes("NACIONALINIS SUSIVIENIJIMAS")) return partyColors["NS"];
      return "#9e9e9e"; // numatytoji pilka
    }

    // Pagalbinė funkcija: įrašyti ryšį A–B su balsų skaičiumi
    function addPair(a, b, votes) {
      if (!adjacency[a]) {
        adjacency[a] = {};
      }
      const current = adjacency[a][b] || 0;
      adjacency[a][b] = current + votes;
    }

    // Sujungimas: "Dalia Asanavičiūtė" → "Dalia Asanavičiūtė-Gružauskienė"
    function mergeDaliaData() {
      const mainName = "Dalia Asanavičiūtė-Gružauskienė";
      const oldName  = "Dalia Asanavičiūtė";

      if (!adjacency[oldName]) return; // jei seno vardo nėra – nieko nedarom

      if (!adjacency[mainName]) adjacency[mainName] = {};

      // 1) Prie pagrindinio pridedam visus seno vardo balsus
      for (const [other, votes] of Object.entries(adjacency[oldName])) {
        adjacency[mainName][other] = (adjacency[mainName][other] || 0) + votes;

        // 2) Kitiems nariams taip pat pridedam balsus už pagrindinį vardą
        if (!adjacency[other]) adjacency[other] = {};
        adjacency[other][mainName] = (adjacency[other][mainName] || 0) + votes;

        // 3) Pašalinam seną vardą iš kitų narių sąrašų
        delete adjacency[other][oldName];
      }

      // 4) Ištrinam seną vardą iš adjacency
      delete adjacency[oldName];

      // 5) Jei partijos nurodytos tik senam vardui, perkeliame
      if (!memberParty[mainName] && memberParty[oldName]) {
        memberParty[mainName] = memberParty[oldName];
      }
      delete memberParty[oldName];
    }

    // Pilnas nario pašalinimas iš sistemos
    function removeMember(name) {
      if (adjacency[name]) {
        // pašalinam jį iš kitų narių sąrašų
        for (const [other, neighbors] of Object.entries(adjacency)) {
          if (neighbors[name] !== undefined) {
            delete neighbors[name];
          }
        }
        // pašalinam jo paties įrašą
        delete adjacency[name];
      }
      // pašalinam partijos informaciją
      if (memberParty[name]) {
        delete memberParty[name];
      }
    }

    // Užpildo <select> pagal adjacency
    function buildMemberSelect() {
      const members = Object.keys(adjacency).sort((a, b) => a.localeCompare(b, "lt"));

      memberSelect.innerHTML = "";
      memberSelect.disabled = members.length === 0;

      if (members.length === 0) {
        statusEl.textContent = "Nerasta nė vieno nario po duomenų apdorojimo.";
        return;
      }

      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "— Pasirink nario vardą ir pavardę —";
      memberSelect.appendChild(defaultOption);

      for (const m of members) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        memberSelect.appendChild(opt);
      }

      statusEl.textContent = "Duomenys įkelti. Pasirink nario vardą ir pavardę.";
      errorEl.style.display = "none";
    }

    // Sukuria partijų filtro pasirinkimus pagal esamą currentRows
    function buildPartyFilterOptions() {
      const partiesSet = new Set();
      currentRows.forEach(row => {
        if (row.partyName && row.partyName.trim()) {
          partiesSet.add(row.partyName.trim());
        }
      });

      const parties = Array.from(partiesSet).sort((a, b) => a.localeCompare(b, "lt"));

      partyFilterSelect.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "ALL";
      allOpt.textContent = "Visos partijos";
      partyFilterSelect.appendChild(allOpt);

      parties.forEach(party => {
        const opt = document.createElement("option");
        opt.value = party;
        opt.textContent = party;
        partyFilterSelect.appendChild(opt);
      });

      partyFilterSelect.disabled = false;
      currentPartyFilter = "ALL";
    }

    // Pritaiko rikiavimą ir filtrą, ir perpiešia lentelę
    function renderRows() {
      resultBody.innerHTML = "";

      let rows = currentRows.slice();

      // filtras pagal partiją
      if (currentPartyFilter !== "ALL") {
        rows = rows.filter(row => row.partyName === currentPartyFilter);
      }

      // rikiavimas
      rows.sort((a, b) => {
        const dir = currentSort.direction === "asc" ? 1 : -1;
        if (currentSort.key === "votes") {
          return (a.votes - b.votes) * dir;
        }
        if (currentSort.key === "name") {
          return a.name.localeCompare(b.name, "lt") * dir;
        }
        if (currentSort.key === "party") {
          return a.partyName.localeCompare(b.partyName, "lt") * dir;
        }
        return 0;
      });

      // atnaujinam header klases
      document.querySelectorAll("th.sortable").forEach(th => {
        th.classList.remove("sorted-asc", "sorted-desc");
        const key = th.getAttribute("data-sort-key");
        if (key === currentSort.key) {
          th.classList.add(currentSort.direction === "asc" ? "sorted-asc" : "sorted-desc");
        }
      });

      // užpildom eilutes
      rows.forEach((row, index) => {
        const tr = document.createElement("tr");

        const tdIndex = document.createElement("td");
        tdIndex.textContent = index + 1;
        tdIndex.className = "number-cell";

        const tdName = document.createElement("td");
        tdName.textContent = row.name;
        tdName.className = "name-cell";

        const partyName = row.partyName || "";
        const partyColor = getPartyColor(partyName);

        const tdParty = document.createElement("td");
        if (partyName) {
          const span = document.createElement("span");
          span.className = "party-badge";
          span.textContent = partyName;
          span.style.backgroundColor = partyColor;
          tdParty.appendChild(span);
        } else {
          tdParty.textContent = "";
        }
        tdParty.className = "party-cell";

        const tdVotes = document.createElement("td");
        tdVotes.textContent = row.votes;
        tdVotes.className = "number-cell";

        tr.appendChild(tdIndex);
        tr.appendChild(tdName);
        tr.appendChild(tdParty);
        tr.appendChild(tdVotes);
        resultBody.appendChild(tr);
      });
    }

    // CSV nuskaitymas ir suparsavimas – balsavimų panašumas
    async function loadCommonVotes() {
      try {
        const response = await fetch("common_votes.csv");
        if (!response.ok) {
          throw new Error("Nepavyko nuskaityti failo „common_votes.csv“. Patikrink, ar jis yra šalia HTML.");
        }

        const text = await response.text();
        const lines = text.split(/\r?\n/).filter(line => line.trim().length > 0);
        if (lines.length < 2) {
          throw new Error("„common_votes.csv“ faile per mažai eilučių.");
        }

        const headerLine = lines[0];
        const delimiter = headerLine.includes(";") ? ";" : ",";

        const headers = headerLine.split(delimiter).map(h => h.trim());
        const idxMember1 = headers.indexOf("member1");
        const idxMember2 = headers.indexOf("member2");
        const idxCommon = headers.indexOf("common_votes");

        if (idxMember1 === -1 || idxMember2 === -1 || idxCommon === -1) {
          throw new Error("„common_votes.csv“ antraštėje turi būti stulpeliai: member1, member2, common_votes.");
        }

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          if (!line.trim()) continue;
          const cols = line.split(delimiter);
          if (cols.length <= Math.max(idxMember1, idxMember2, idxCommon)) continue;

          const m1 = cols[idxMember1].trim();
          const m2 = cols[idxMember2].trim();
          const votesStr = cols[idxCommon].trim();

          if (!m1 || !m2 || !votesStr) continue;

          const votes = Number(votesStr.replace(",", "."));
          if (!Number.isFinite(votes)) continue;

          addPair(m1, m2, votes);
          addPair(m2, m1, votes);
        }

        statusEl.textContent = "Balsavimų duomenys įkelti, tvarkome sąrašą...";

      } catch (err) {
        console.error(err);
        statusEl.textContent = "";
        errorEl.textContent = err.message;
        errorEl.style.display = "block";
      }
    }

    // CSV su partijomis: members_parties.csv (member, party)
    async function loadParties() {
      try {
        const response = await fetch("members_parties.csv");
        if (!response.ok) {
          // Jei failo nėra – programa vis tiek veiks
          console.warn("Nepavyko nuskaityti „members_parties.csv“. Partijos nebus rodomos.");
          return;
        }

        const text = await response.text();
        const lines = text.split(/\r?\n/).filter(line => line.trim().length > 0);
        if (lines.length < 2) {
          console.warn("„members_parties.csv“ faile per mažai eilučių.");
          return;
        }

        const headerLine = lines[0];
        const delimiter = headerLine.includes(";") ? ";" : ",";
        const headers = headerLine.split(delimiter).map(h => h.trim());

        const idxMember = headers.indexOf("member");
        const idxParty  = headers.indexOf("party");

        if (idxMember === -1 || idxParty === -1) {
          console.warn("„members_parties.csv“ antraštėje turi būti stulpeliai: member, party.");
          return;
        }

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          if (!line.trim()) continue;
          const cols = line.split(delimiter);
          if (cols.length <= Math.max(idxMember, idxParty)) continue;

          const member = cols[idxMember].trim();
          const party  = cols[idxParty].trim();
          if (!member) continue;

          memberParty[member] = party;
        }

      } catch (err) {
        console.error("Klaida skaitant „members_parties.csv“:", err);
      }
    }

    // Vartotojas pasirenka konkretų narį
    memberSelect.addEventListener("change", () => {
      const selected = memberSelect.value;
      resultBody.innerHTML = "";

      if (!selected || !adjacency[selected]) {
        statusEl.textContent = selected
          ? "Šiam nariui nerasta sutapimų."
          : "Pasirink nario vardą ir pavardę.";
        currentRows = [];
        renderRows();
        return;
      }

      const partners = adjacency[selected];
      currentRows = Object.entries(partners)
        .map(([name, votes]) => ({
          name,
          partyName: memberParty[name] || "",
          votes
        }));

      // numatytasis rikiavimas – pagal balsų skaičių (nuo didžiausio)
      currentSort = { key: "votes", direction: "desc" };

      // atnaujinam partijos filtrą pagal šiuos duomenis
      buildPartyFilterOptions();

      statusEl.textContent =
        "Rodomi nariai, su kuriais „" + selected + "“ dažniausiai balsavo vienodai (nuo didžiausio iki mažiausio bendrų balsų skaičiaus).";

      renderRows();
    });

    // Partijos filtro keitimas
    partyFilterSelect.addEventListener("change", () => {
      currentPartyFilter = partyFilterSelect.value || "ALL";
      renderRows();
    });

    // Rikiavimas paspaudus ant stulpelio antraštės
    document.querySelectorAll("th.sortable").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.getAttribute("data-sort-key");
        if (!key) return;

        if (currentSort.key === key) {
          // jei spaudžiam tą patį stulpelį – keičiam kryptį
          currentSort.direction = currentSort.direction === "asc" ? "desc" : "asc";
        } else {
          // naujas stulpelis – numatytas rikiavimas
          currentSort.key = key;
          currentSort.direction = key === "votes" ? "desc" : "asc";
        }

        renderRows();
      });
    });

    // Inicijuojame – krauname abu CSV, po to tvarkome specialius atvejus
    (async function init() {
      await Promise.all([
        loadCommonVotes(),
        loadParties()
      ]);

      // sujungiame Dalių duomenis
      mergeDaliaData();

      // pašaliname Liudą Mažylį iš sistemos
      removeMember("Liudas Mažylis");

      // sukuriame pasirinkimų sąrašą
      buildMemberSelect();
    })();
  </script>
</body>
</html>
